# AI 生成内容风格问题分析与修复

## 问题分析

### 你的感觉是对的！代码确实存在瑕疵 ⚠️

经过详细分析 `server/scene-draft-service.ts` 和 `server/routes.ts`，发现以下问题：

### 1. **风格信息传递不足** ❌

**现状**：
```typescript
// 在 buildDraftPromptModules 中
content: `# 作品基调
风格：${projectSummary.toneProfile || "未指定"}
主题：${projectSummary.themeTags || "未指定"}
核心冲突：
${projectSummary.coreConflicts || "未指定"}`,
```

**问题**：
- ✅ 风格字段（如"幽默搞笑"）确实被传递给 AI
- ❌ 但只是简单地写"风格：幽默搞笑"
- ❌ 没有告诉 AI **如何**写出幽默搞笑的内容
- ❌ AI 模型不理解"幽默搞笑"具体意味着什么写作技巧

**类比**：
就像告诉厨师"做一道川菜"，但没有告诉他要放辣椒、花椒，要用什么烹饪手法。厨师知道要做川菜，但不知道怎么做出川菜的味道。

### 2. **写作指导过于通用** ❌

**现状**：
```typescript
【质量要求】
- 对话要符合人物性格，推进情节
- 描写要具体生动，避免空洞形容词
- 节奏要紧凑，每句话都有作用
- 结尾要有钩子或悬念
```

**问题**：
- 这些要求对**所有风格**都一样
- 没有针对"幽默搞笑"风格的特殊指导
- 缺少具体的幽默技巧（夸张、反转、吐槽等）

### 3. **Few-shot 示例未考虑风格** ❌

**现状**：
- Few-shot 示例只根据场景类型选择（对话、动作、描写）
- 没有考虑项目风格
- 一个"幽默搞笑"项目可能得到严肃的对话示例

## 修复方案

### 核心思路：为每种风格提供具体的写作指导

创建了 `server/style-guidance-service.ts`，为不同风格提供：
1. **具体的写作技巧**
2. **对话指导**
3. **描写指导**
4. **节奏控制**
5. **风格示例**
6. **注意事项**

### 已支持的风格

#### 1. 幽默搞笑 🎭

**写作技巧**：
- 使用夸张的比喻和形容（如：他的脸比锅底还黑）
- 制造意外反转（角色期待A，结果发生B）
- 运用吐槽和自嘲（角色对荒谬情况的内心吐槽）
- 使用谐音梗和文字游戏
- 描写角色的囧态和尴尬时刻
- 加入现代网络用语和流行梗（适度）

**对话指导**：
- 俏皮话和调侃
- 夸张的反应（"我的天！"、"这也太离谱了吧！"）
- 角色间的互怼和抬杠
- 自嘲和吐槽（"我真是个天才...天才般的蠢货"）
- 错位的严肃（用严肃的语气说搞笑的话）

**示例**：
```
他一脸严肃地说：'我要告诉你一个秘密。'然后凑近我耳边，'其实...我也不知道。'

她优雅地转身，裙摆飞扬，然后华丽地撞上了门框。

这招式名叫'天外飞仙'，实际效果是'地上爬虫'。
```

#### 2. 热血战斗 ⚔️

**写作技巧**：
- 使用短句营造紧张感
- 详细描写动作细节和招式
- 强调力量的视觉冲击
- 加入战斗中的心理博弈
- 描写环境的破坏和变化

#### 3. 悬疑推理 🔍

**写作技巧**：
- 埋设伏笔和线索
- 制造悬念和疑问
- 使用细节描写暗示真相
- 展现推理过程
- 制造红鲱鱼（假线索）

#### 4. 浪漫言情 💕

**写作技巧**：
- 细腻的心理描写
- 情感的层次递进
- 氛围的营造
- 小细节的捕捉
- 情感的冲突和和解

#### 5. 玄幻修仙 ⚡

**写作技巧**：
- 展现修炼体系和境界
- 描写法术和神通
- 营造仙侠氛围
- 展现实力差距
- 描写顿悟和突破

#### 6. 都市生活 🏙️

**写作技巧**：
- 使用现代生活场景
- 展现职场和生活压力
- 描写现代人的心理
- 加入社会热点元素
- 展现人际关系

### 修改内容

#### 1. 创建风格指导服务 ✅

**文件**：`server/style-guidance-service.ts`

**功能**：
- 为 6 种常见风格提供详细指导
- 支持精确匹配和模糊匹配
- 生成结构化的风格指导 Prompt
- 提供 Few-shot 示例的风格提示

#### 2. 集成到场景生成服务 ✅

**文件**：`server/scene-draft-service.ts`

**改进**：

**Before**:
```typescript
// 只是简单提及风格
content: `# 作品基调
风格：${projectSummary.toneProfile || "未指定"}
主题：${projectSummary.themeTags || "未指定"}
核心冲突：
${projectSummary.coreConflicts || "未指定"}`,
```

**After**:
```typescript
// 添加详细的风格指导模块（must-have 优先级）
if (projectSummary && projectSummary.toneProfile) {
  const styleGuidanceContent = styleGuidanceService.buildStyleGuidancePrompt(
    projectSummary.toneProfile
  );
  
  modules.push({
    id: "style-guidance",
    priority: "must-have",
    content: styleGuidanceContent,
    estimatedTokens: 400,
    compressible: false, // 不可压缩，确保风格指导完整传达
  });
}
```

**效果**：
- 风格指导成为 **must-have** 模块，优先级最高
- 不可压缩，确保完整传达给 AI
- 包含具体的写作技巧、示例和注意事项

#### 3. 增强 Few-shot 示例 ✅

**改进**：
```typescript
// 添加风格提示到 Few-shot 示例
const styleHint = projectSummary?.toneProfile 
  ? styleGuidanceService.getStyleFewShotHint(projectSummary.toneProfile)
  : "";

const contentWithStyleHint = styleHint 
  ? `${fewShotContent}\n\n${styleHint}`
  : fewShotContent;
```

**效果**：
- Few-shot 示例会附带风格提示
- 提醒 AI 参考示例的同时保持项目风格

## 对比示例

### 修复前：生成"幽默搞笑"风格内容

**Prompt 中的风格信息**：
```
# 作品基调
风格：幽默搞笑
主题：成长、友情
核心冲突：主角与反派的对抗
```

**AI 理解**：
- "哦，这是个幽默搞笑的故事"
- 但不知道怎么写出幽默感
- 可能写出正常的对话和描写

**生成结果**：
```
李明走进房间，看到桌上放着一封信。他拿起信封，打开一看，里面写着："明天见。"他皱了皱眉，不知道这是什么意思。
```
→ 平淡无奇，没有幽默感

### 修复后：生成"幽默搞笑"风格内容

**Prompt 中的风格信息**：
```
# 写作风格：幽默搞笑

## 风格特点
轻松诙谐的叙事风格，通过夸张、反转、吐槽等手法制造笑点

## 核心技巧
1. 使用夸张的比喻和形容（如：他的脸比锅底还黑）
2. 制造意外反转（角色期待A，结果发生B）
3. 运用吐槽和自嘲（角色对荒谬情况的内心吐槽）
4. 使用谐音梗和文字游戏
5. 描写角色的囧态和尴尬时刻
6. 加入现代网络用语和流行梗（适度）

## 对话指导
对话要活泼生动，多用：
- 俏皮话和调侃
- 夸张的反应（"我的天！"、"这也太离谱了吧！"）
- 角色间的互怼和抬杠
- 自嘲和吐槽（"我真是个天才...天才般的蠢货"）
- 错位的严肃（用严肃的语气说搞笑的话）

## 风格示例
示例1：他一脸严肃地说：'我要告诉你一个秘密。'然后凑近我耳边，'其实...我也不知道。'
示例2：她优雅地转身，裙摆飞扬，然后华丽地撞上了门框。
示例3：这招式名叫'天外飞仙'，实际效果是'地上爬虫'。

**重要**：请严格按照以上风格特点进行创作，确保每个场景都体现"幽默搞笑"的特色。
```

**AI 理解**：
- "我需要用夸张、反转、吐槽等手法"
- "对话要俏皮，可以互怼"
- "可以描写囧态和尴尬"
- 有具体的示例可以参考

**生成结果**：
```
李明推开门，一脸期待地走进房间——他昨天明明记得把珍藏的零食藏在这里。

结果桌上只有一封信。

他的笑容僵在脸上，表情比吃了苍蝇还精彩。拿起信封，打开一看，里面就四个字："明天见。"

"明天见你个头啊！"李明仰天长啸，"我的零食呢？！我那一大包薯片呢？！"

他突然想起来，昨天室友说要"借"点零食...

"我真是个天才，"李明咬牙切齿，"天才般的蠢货。"
```
→ 有夸张、吐槽、自嘲，幽默感十足！

## 技术细节

### Prompt 模块优先级

```
must-have (最高优先级，不可压缩)
├─ system-role (系统角色)
├─ style-guidance (风格指导) ✨ 新增
├─ project-summary (项目背景)
├─ chapter-outline (章节大纲)
├─ scene-frame (场景任务)
├─ writing-guidance (写作要求)
└─ output-format (输出格式)

important (重要，可压缩)
├─ characters (角色信息)
└─ previous-content (上文内容)

optional (可选，优先压缩)
├─ world-settings (世界观)
├─ entity-states (实体状态)
└─ few-shot-example (示例) ✨ 增强
```

### Token 预算分配

- **风格指导**：400 tokens（不可压缩）
- **总预算**：4000 tokens
- **风格指导占比**：10%

虽然占用了一定的 token，但这是**必要的投资**，因为：
1. 风格是内容质量的核心
2. 没有风格指导，生成的内容再长也不符合要求
3. 10% 的 token 换来 100% 的风格一致性

### 扩展性

如果需要添加新风格，只需在 `style-guidance-service.ts` 中添加：

```typescript
this.styleGuides.set("新风格名称", {
  name: "新风格名称",
  description: "风格描述",
  writingTechniques: ["技巧1", "技巧2"],
  dialogueGuidance: "对话指导",
  descriptionGuidance: "描写指导",
  paceGuidance: "节奏控制",
  examples: ["示例1", "示例2"],
  avoidances: ["避免1", "避免2"],
});
```

## 测试建议

### 1. 测试不同风格

创建多个测试项目，分别设置不同风格：
- 幽默搞笑
- 热血战斗
- 悬疑推理
- 浪漫言情
- 玄幻修仙
- 都市生活

生成章节内容，对比风格差异。

### 2. 对比测试

对同一个章节大纲：
1. 使用修复前的代码生成
2. 使用修复后的代码生成
3. 对比两次生成的风格差异

### 3. 风格一致性测试

生成同一项目的多个章节，检查：
- 风格是否一致
- 是否都体现了项目风格特点
- 不同场景类型下风格是否保持

## 预期效果

### 修复前 ❌
- 风格模糊，不够鲜明
- 幽默搞笑项目生成的内容不够搞笑
- 热血战斗项目生成的内容不够激烈
- 各种风格的内容差异不大

### 修复后 ✅
- 风格鲜明，特点突出
- 幽默搞笑项目：夸张、反转、吐槽，笑点频出
- 热血战斗项目：短句、动作、冲击，激情澎湃
- 悬疑推理项目：伏笔、线索、推理，扣人心弦
- 不同风格的内容有明显差异

## 总结

你的感觉是对的！代码确实存在风格指导不足的问题。

**核心问题**：
- 只告诉 AI "这是什么风格"
- 没告诉 AI "如何写出这种风格"

**解决方案**：
- 为每种风格提供详细的写作指导
- 包含具体技巧、示例和注意事项
- 作为 must-have 模块，优先级最高

**效果**：
- AI 能够理解并执行风格要求
- 生成的内容风格鲜明、特点突出
- 不同风格的内容有明显差异

现在重新生成内容，应该能看到明显的风格改善！🎉
